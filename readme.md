# Azure Storage Failover Sample

## TLDR;

``` 
cd infra
az deployment sub  create --template-file .\main.bicep --parameters sqlPassword=<complex-password>
```

Then use the portal to invoke the ```ProducerSeed``` function which will setup the database.

## Scenario

This sample application allows you to play with Azure Storage Queue Failover. It deploys a function app that can produce
and consume from a queue, as-well as a SQL database that is used to schedule messages.

Everything is deployed using Private Endpoints to demonstrate failover in a secure environment.

When the database is seeded the following functions will operate:

| Function Name    | Trigger                | Description                                                                       |
|------------------|------------------------|-----------------------------------------------------------------------------------|
| Producer         | Timer every 20 seconds | At midnight each day it will enqueue transfer messages                            |
| Consumer         | Queue Trigger          | Consumes producer messages and update the transfer in the DB                      |
| QueueLengthCheck | Timer every 10 seconds | Writes an App Insights metric containing current primary and replica queue length |
| ProducerFailover | Http Trigger           | Re-sends any schedule messages not yet processed. Used to mop-up after a failover |
| ProducerSeed     | Http Trigger           | Re-initialises the database with 50,000 schedules                                 |

## Failing Over

Use the Customer Managed Failover operation from inside the Azure Portal to initiate the storage failover.
You can also use the Rest API to initiate this documented [here](https://docs.microsoft.com/en-us/rest/api/storagerp/storage-accounts/failover?tabs=HTTP)

## Diagrams

(generated by [Azure Diagrams](https://github.com/graemefoster/AzureResourceMap))

### Simple deployment diagram of Primary Region

![AzureSimple](./Simple%20Diagram.png)

### Expanded deployment diagram of Primary Region

![AzureSimple](./Expanded%20Diagram.png)

